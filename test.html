<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />

    <title>routeDB</title>
</head>

<body onload="init()">
    <header class="sticky-top">
        <div class="input-group">
            <div class="input-group-prepend">
                <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
                    tags
                </button>
                <div class="dropdown-menu p-4 text-muted overflow-auto" style="height: 150px" id="uniqueTagsList"></div>
            </div>
            <input type="text" id="keyword" class="form-control" aria-label="Recipient's username with two button addons" aria-describedby="button-addon4" />
            <div class="input-group-append" id="button-addon4">
                <button class="btn btn-secondary" type="button" onclick="findLocal('')">
                    find
                </button>
            </div>
        </div>
    </header>
    <!-- GoogleMap -->
    <main>
        <div id="map-canvas" style="width: 100%; height: 400px; background: #eee;"></div>
        <div class="list-group" id="list" style="padding-bottom: 45px;"></div>
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <form id="addForm" role="form" target="dummy_send_target">
                            <input type="text" id="uuid" name="entry.830464835" />
                            <input type="text" id="hidprefecture" name="entry.2063422698" />
                            <input type="text" id="hidline" name="entry.32936375" />
                            <input type="text" id="hidstation" name="entry.374273456" />
                            <div class="form-group">
                                <label for="recipient-name" class="col-form-label">name</label>
                                <input type="text" class="form-control" id="name" name="entry.702018835" />
                            </div>
                            <div class="form-group">
                                <label for="message-text" class="col-form-label">tag</label>
                                <input type="text" class="form-control" id="tag" name="entry.292332180" placeholder="#喫茶店#プリン#喫煙可" />
                            </div>
                            <br>
                            <div style="text-align: right;">
                                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary btn-sm">add</button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-body" id="modal_msg" style="display: none">
                        <p>success!</p>
                        <div class="text-right">
                            <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" onclick="closeModalMsg()">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="fixed-bottom">
        <div class="btn-group dropup" style="width:100%;">
            <button class="btn btn-secondary" type="button" onclick="location.reload();">routeDB</button>
            <select class="form-select" style="width:50%;" aria-label="Default select example">
                <option selected>Menu</option>
                <option value="1">About</option>
                <option value="2">Terms of use</option>
                <option value="3">Privacy Policy</option>
                <option value="4">Contact us</option>
            </select>
        </div>
    </footer>
    <!-- Optional JavaScript; choose one of the two! -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCix65IjkwpYudG66diaCPfbBvZhlXFbwY"></script>
    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script>
        const addFormUrl = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSfxJKrinoa9GDPeRnfcBUkanT1fORUW_Ty3KSW8mme7jGhTsw/formResponse';
        const dataUrl = 'https://script.google.com/macros/s/AKfycbwE4gF6_jttSLO_z50XV8rhnMs4VYSF3bH-JEOQcitabAA9uG1POFsvkVqHxReLzK5h/exec';

        const getRouteDB = async() => {
            const url = `https://script.google.com/macros/s/AKfycbwE4gF6_jttSLO_z50XV8rhnMs4VYSF3bH-JEOQcitabAA9uG1POFsvkVqHxReLzK5h/exec?sn=routedb`;
            const response = await fetch(url, {
                method: "get"
            });
            const json = response.json();
            if (response.status == 200) {
                return Promise.resolve(json);
            } else {
                return Promise.reject(json.error);
            }
        };

        const getPrefectures = async() => {
            const url = `https://routedb.github.io/data/mst_prefecture.json`;
            const response = await fetch(url, {
                method: "get"
            });
            const json = response.json();
            if (response.status == 200) {
                return Promise.resolve(json);
            } else {
                return Promise.reject(json.error);
            }
        };

        const getLine = async() => {
            const url = `https://routedb.github.io/data/mst_line.json`;
            const response = await fetch(url, {
                method: "get"
            });
            const json = response.json()
            if (response.status == 200) {
                return Promise.resolve(json);
            } else {
                return Promise.reject(json.error);
            }
        };

        const getStationList = async() => {
            const url = `https://routedb.github.io/data/v_mst_station.json`;
            const response = await fetch(url, {
                method: "get"
            });
            const json = response.json();
            if (response.status == 200) {
                return Promise.resolve(json);
            } else {
                return Promise.reject(json.error);
            }
        };

        const getStation = async() => {
            const url = `https://routedb.github.io/data/v_mst_station.json`;
            const response = await fetch(url, {
                method: "get"
            });
            const json = response.json();
            if (response.status == 200) {
                return Promise.resolve(json);
            } else {
                return Promise.reject(json.error);
            }
        };

        function init() {
            getMyPlace();
            getRouteDB()
                .then((data) => {
                    console.log(data);
                })
                .catch((err) => {
                    console.log(err);
                });
            getPrefectures()
                .then((data) => {
                    console.log(data);
                    let out = "";
                    for (let prefecture_idx in data) {
                        out += '<a href="#" class="list-group-item list-group-item-action" id="prefElement' +
                            data[prefecture_idx].prefecture_id +
                            '" onclick="drawLine(this,\'' +
                            data[prefecture_idx].prefecture +
                            "')\">";
                        out += "<strong>" + data[prefecture_idx].prefecture + "</strong>";
                        out += '<span class="badge badge-pill badge-light" id="badge_pref' +
                            data[prefecture_idx].prefecture_id +
                            '"></span></a>';
                    }
                    document.getElementById("list").innerHTML = out;
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function drawLine(elem, prefecture) {
            getLine(prefecture)
                .then((data) => {
                    console.log(elem.outerHTML);
                    console.log(data);
                    let filterData = data.filter(value => {
                        if (value.prefecture.indexOf(prefecture) !== -1) {
                            return value
                        }
                    });
                    let out = '<a href="#" class="list-group-item list-group-item-action" id="prefElement' +
                        filterData[0].prefecture_id +
                        '" onclick="drawLine(this,\'' +
                        filterData[0].prefecture +
                        "')\">";
                    out += "<strong>" + filterData[0].prefecture + "</strong>";
                    out += '<span class="badge badge-pill badge-light" id="badge_pref' +
                        filterData[0].prefecture_id +
                        '"></span></a>';;
                    for (let line_idx in filterData) {
                        out += '<a href="#" class="list-group-item list-group-item-action" style="padding-left:25px;" id="lineElement' +
                            filterData[line_idx].line_id +
                            '" onclick="drawStationList(this,\'' +
                            filterData[line_idx].line_id +
                            "','" +
                            filterData[line_idx].line +
                            "')\">";
                        out += "<strong>" + filterData[line_idx].line + "</strong>";
                        out += '<span class="badge badge-pill badge-light" id="badge_line' +
                            filterData[line_idx].line_id +
                            '"></span></a>';
                    }
                    document.getElementById("list").innerHTML = out;
                })
                .catch((err) => {});
        }

        function drawStationList(elem, line_id, line) {
            getStationList()
                .then((data) => {
                    console.log(elem.outerHTML);
                    console.log(data);
                    let filterData = data.filter(value => {
                        if (value.line.indexOf(line) !== -1) {
                            return value
                        }
                    });
                    let out = elem.parentElement.children[0].outerHTML + elem.outerHTML;
                    for (let station_idx in filterData) {
                        out += '<a href="#" class="list-group-item list-group-item-action" style="padding-left:35px;" id="stationElement' +
                            filterData[station_idx].station_id +
                            '" onclick="drawStation(this,\'' +
                            filterData[station_idx].station_name +
                            "','" +
                            filterData[station_idx].prefecture +
                            "','" +
                            filterData[station_idx].line +
                            "')\">";
                        out += "<strong>" + filterData[station_idx].station_name + "</strong>";
                        out += '<span class="badge badge-pill badge-light" id="badge_stationList' +
                            filterData[station_idx].station_id +
                            '"></span></a>';
                    }
                    document.getElementById("list").innerHTML = out;
                    drowPolyline(filterData);
                })
                .catch((err) => {});
        }

        function drawStation(elem, station, prefecture, line) {
            getStation()
                .then((data) => {
                    let filterData = data.filter(value => {
                        if (value.line.indexOf(line) !== -1 && value.station_name.indexOf(station) !== -1 && value.prefecture.indexOf(prefecture) !== -1) {
                            return value
                        };
                    });
                    let out = "";
                    out += '<a href="#" class="list-group-item list-group-item-action" id="prefElement' +
                        filterData[0].prefecture_id +
                        '" onclick="drawLine(this,\'' +
                        filterData[0].prefecture +
                        "')\">";
                    out += "<strong>" + filterData[0].prefecture + "</strong>";
                    out += '<span class="badge badge-pill badge-light" id="badge_pref' +
                        filterData[0].prefecture_id +
                        '"></span></a>';

                    out += '<a href="#" class="list-group-item list-group-item-action" style="padding-left:25px;" id="lineElement' +
                        filterData[0].line_id +
                        '" onclick="drawStationList(this,\'' +
                        filterData[0].line_id +
                        "','" +
                        filterData[0].line +
                        "')\">";
                    out += "<strong>" + filterData[0].line + "</strong>";
                    out += '<span class="badge badge-pill badge-light" id="badge_line' +
                        filterData[0].line_id +
                        '"></span></a>';

                    let transferData = [];
                    filterData[0].transfer_line.split('/').forEach(function(value2) {
                        console.log(value2);
                        transferData.push(data.filter(value => {
                            if (value.line.indexOf(value2) !== -1) {
                                return value
                            };
                        }));
                    });
                    let convertTransferData = [];
                    transferData.forEach(function(arr) {
                        convertTransferData.push(arr.filter(value => {
                            if (value.station_name.indexOf(filterData[0].station_name) !== -1 && value.prefecture.indexOf(filterData[0].prefecture) !== -1) {
                                return value
                            };
                        }));
                    });
                    for (let convertTransfer_idx in convertTransferData) {
                        if (convertTransferData[0][0].transfer_line != "") {
                            out += '<a href="#" class="list-group-item list-group-item-action" style="padding-left:25px;" id="lineElement' +
                                convertTransferData[convertTransfer_idx][0].line_id +
                                '" onclick="drawStationList(this,\'' +
                                convertTransferData[convertTransfer_idx][0].line_id +
                                "','" +
                                convertTransferData[convertTransfer_idx][0].line +
                                "')\">";
                            out += "<strong>" + convertTransferData[convertTransfer_idx][0].line + "</strong>";
                            out += '<span class="badge badge-pill badge-light" id="badge_line' +
                                convertTransferData[convertTransfer_idx][0].line_id +
                                '"></span></a>';
                        }
                    }

                    out += '<a href="#" class="list-group-item list-group-item-action" style="padding-left:35px;" id="stationElement' +
                        filterData[0].station_id +
                        '" onclick="drawStationList(this,\'' +
                        filterData[0].station_name +
                        "','" +
                        filterData[0].line +
                        "')\">";
                    out += "<strong>" + filterData[0].station_name + "</strong>";
                    out += '<span class="badge badge-pill badge-light" id="badge_station' +
                        filterData[0].station_id +
                        '"></span></a>';
                    document.getElementById("list").innerHTML = out +
                        '<a href="#" class="list-group-item list-group-item-action list-group-item-danger" data-bs-toggle="modal" data-bs-target="#exampleModal" style="text-align:center;">✙<strong>add</strong></a>';
                    drowMap(filterData[0].lat, filterData[0].lng);
                })
                .catch((err) => {});
        }

        function getMyPlace() {
            if (!navigator.geolocation) {
                alert("<p>Geolocationはあなたの端末でサポートされておりません</p>");
                return;
            }

            function success(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                drowMap(lat, lng);
            }

            function error() {
                alert("座標位置を取得できません");
            }
            navigator.geolocation.getCurrentPosition(success, error);
        }

        function drowMap(lat, lng) {
            var latlng = new google.maps.LatLng(lat, lng);
            var map = new google.maps.Map(document.getElementById("map-canvas"), {
                zoom: 15,
                center: latlng,
            });
            new google.maps.Marker({
                map: map,
                position: latlng,
            });
        }

        function drowPolyline(lineData) {
            var latlng = new google.maps.LatLng(lineData[0].lat, lineData[0].lng);
            var opts = {
                zoom: 10,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                center: latlng
            };
            var lat_lng = [];
            for (var idx in lineData) {
                lat_lng.push(new google.maps.LatLng(lineData[idx].lat, lineData[idx].lng));
            }
            var map = new google.maps.Map(document.getElementById("map-canvas"), opts);
            var polylineOpts = {
                map: map,
                strokeColor: "#FF0000",
                strokeOpacity: 1.0,
                strokeWeight: 3,
                path: lat_lng
            };
            var polyline = new google.maps.Polyline(polylineOpts);
        }

        function get_textbox_value(name) {
            const element = document.querySelector(`input[type=text][name="${name}"]`);
            if (element.value) {
                return element.value;
            } else {
                return ""
            }
        }

        function ask_before_changing_page(event) {
            event.preventDefault();
            event.returnValue = "";
        }

        document.getElementById("addForm").addEventListener("submit", function() {
            const dummy_send_target = document.createElement("iframe");
            dummy_send_target.style.display = "none";
            dummy_send_target.name = "dummy_send_target";
            document.getElementById("addForm").appendChild(dummy_send_target);

            const form_iframe = document.createElement("iframe");
            form_iframe.src = encodeURI(addFormUrl + `?entry.830464835=${get_textbox_value("entry.830464835")}&entry.2063422698=${get_textbox_value("entry.2063422698")}&entry.32936375=${get_textbox_value("entry.32936375")}&entry.374273456=${get_textbox_value("entry.374273456")}&entry.702018835=${get_textbox_value("entry.702018835")}&entry.292332180=${get_textbox_value("entry.292332180")}&submit=Submit`);
            form_iframe.style.display = "none";
            document.getElementById("addForm").appendChild(form_iframe);

            form_iframe.addEventListener("load", function() {
                document.getElementById("addForm").remove();
                document.getElementById("modal_msg").style.display = "block";
                //window.removeEventListener("beforeunload", ask_before_changing_page, false);
            });
        });

        //window.addEventListener("beforeunload", ask_before_changing_page);
    </script>
</body>

</html>